
(function( $ ){
	
	"use strict";

	var tvaStageAjaxLoadData = function( container, opts, offset )
	{
		var type			= $( container ).attr('data-type'), 
			source 			= $( container ).attr('data-source'),
			query 			= $( container ).attr('data-query'),
			ajax_url 		= $( container ).attr('data-ajaxurl'),
			attributes 	= $( container ).attr('data-attributes'),	
			data_offset 	= offset,	
			load_value 	= $( container + ' .dynamic-frame').attr('data-load-value'),
			total 			= $( container + ' .dynamic-frame').attr('data-total'),
			data 			= '';				
	
		$( container ).attr('data-query', 'loading');
			
		$.ajax({
			url: ajax_url,
			type:'POST',
			data:{
				action			: 'tva_ajaxdata',
				query			: query,
				type			: type,
				source			: source,
				data_offset	: data_offset,
				load_value		: load_value,
				attributes		: attributes,
		  },
		  success:function(data)
		  {
				if( data != '' && data_offset < total )
				{
					opts.addSlide( data );
					$( container ).attr('data-query', query );
				}
			}	  
		});		
	}		
		
	/* :: 	Resize Canvas											  
	---------------------------------------------*/
		
	$.fn.resize_canvas = function(get_elem_h) {
			
		var elem=$(this);
			
		$(elem).find('.reflect canvas').each(function() {
			var canvas_h=$(this).height();
			
			var gridwrap_h = $(this).closest(get_elem_h).height();
			var new_canvas_h = gridwrap_h-canvas_h;
			new_canvas_h=new_canvas_h/100*12;
			$(this).css('height',new_canvas_h);
		});
	}
		

	/* :: Gallery Reszier
	---------------------------------------------*/
		
	$.fn.resizegallery = function(height,action,priElement,secElement,iSlider,forceHeight) {
				
			var currentheight='';
				
			if( !height ) { 
				$(this).find(priElement).each( function(e) {
					if($(this).css('display') == 'block') {
						currentheight=$(this).height();
						if(!currentheight && forceHeight) {		
							currentheight = forceHeight;	
						}
					}
				});
			}
			else
			{ 
				currentheight=height;
			}
			
			if( action=='animate' )
			{	
			
				if( iSlider ) var speed = 250; else var speed = 750;
				
				$(this).find(secElement).animate({
						height: currentheight
					}, speed, function() {
						// Animation complete.
					});		
			}
			else
			{
					$(this).find(secElement).css({
						height: currentheight
					});				
			}
	}
	

	/* :: 	Stage Gallery							      
	---------------------------------------------*/

	var stage_gallery = function() {			

				$('.gallery-wrap.stage').each(function(index, value) { 	
						
					var gallery = '#'+$(this).attr('id'),
						type = $( gallery ).attr("data-stage-type"),
						nav = $( gallery ).attr("data-stage-nav"),
						effect = $( gallery ).attr("data-stage-effect"),
						easing = $( gallery ).attr("data-stage-easing"),
						timeout_array = '',
						zoom = '';
						
						if( effect == 'fadeZoom' )
						{
							effect = 'fade';
						 	zoom = 'enable';
						}
						
						if( $( gallery + " .timeout_array").val() ) timeout_array = $( gallery + " .timeout_array").val();

						// Cycle through iframe(s) > retrieve src and create data-src. 
						$( gallery +' iframe').each(function(index, value) { 
							var src = $(this).attr('src');
							$(this).attr('data-src',src);
						});						
				
								
						$( gallery + ' .control-panel').append('<ul class="nav"></ul>');

						
						// Create jQuery Cycle Slider
						$( gallery + ' .stage-slider').cycle({ 
							fx:    effect, 
							easing: easing,
							timeoutFn: calculateTimeout,
							speed: 750,	
							before:  onBefore,
							slideExpr: '.panel',
							slideResize: 0,
							//pause: false,
							after:  onAfter,
							pager:  gallery + ' .control-panel .nav',
							cleartype:  true,
							cleartypeNoBg:  true,
							next:   gallery + ' .nav-next', 
							prev:   gallery + ' .nav-prev',
							pagerAnchorBuilder: function(idx, slide) { 
					
								return '<li><a href="#"></a></li>'; 
								
							} 
				
						});

						$( gallery + ' a.nav-pause').click(function() { 
							$( gallery + ' .stage-slider' ).cycle('toggle'); 
							$( this ).find('i.fa').toggleClass("fa-pause fa-play");
						});
											

						// Add Pause Class
						if( !$( gallery ).parent().hasClass('fullslider') && ! $( gallery + ' a.nav-pause' ).length ) // Do not pause full-screen or pause when pause button is present
						{					
							$( gallery ).bind('hover', function(e)
							{								
								$( gallery + ' .stage-slider' ).cycle('toggle'); 
							 
								var status = (e.type === "mouseenter") ? 'paused' : 'resumed'; 
								
								if( status == 'paused' )
								{
									$(this).addClass( 'paused' );	
								}
								else
								{
									$(this).removeClass( 'paused' );	
								}
							}); 
						}
						
						// Remove Active Class on Navigation Click
						$( gallery + ' .slidernav a').click(function() {
							$( gallery + ' .caption-wrap' ).removeClass('active', 700, "easeOutBounce" );
						});
				
						// Gesture Support
						$( gallery ).touchwipe({
							preventDefaultEvents: false,
								wipeLeft: function() {
									$( gallery + ' .stage-slider').cycle('next');
									return false;
								},
								wipeRight: function() {
									$( gallery + ' .stage-slider').cycle("prev");
									return false;
								}
						});

						// Keyboard Control
						$(document).bind('keydown', function(e)
						{
							if (e.keyCode == 37)
							{
								$( gallery + ' .stage-slider').cycle("prev");
							}
							else if(e.keyCode == 39)
							{
								$( gallery + ' .stage-slider').cycle("next");
							}
						});	
											
	
						// Resize Elements
						$(window).resize(function() {
							
							if( $( gallery + ' .panel').length>1 )
							{
								$( gallery ).resizegallery('','','.panel.current','.slider-inner-wrap'); // resize gallery
							}
							else
							{
								$( gallery ).resizegallery('','','.panel','.slider-inner-wrap'); // resize gallery
							}
				
						});						
			
						function onBefore() {											 											

							$(this).find('img,.image-wrapper,.caption').css({ 
								'-webkit-animation': 'none ',
								'animation': 'none'
							});						

							if( $.support.transition === false )
							{
								//$(this).find('img').css({ 'max-width' : '100%','width' : '100%','max-height' : '100%' });
							}							
						
							$( gallery + ' .panel').removeClass('current');
							$( gallery + ' .caption-wrap').removeClass('active');
							$(this).addClass('current');
					
				
						
							$( gallery ).resizegallery( $(this).height(),'animate','.panel','.slider-inner-wrap' ); // resize gallery	
							
				
							if($.browser.msie || $.browser.opera) { // resize canvas
								$('.stage-slider .panel.current').resize_canvas('.panel');
							}

							// JW player
							if( $( gallery ).find('.jwplayer-wrapper.autoplay').length )
							{	
								$( gallery ).find('.jwvideo').each(function(index, element) {
									var jw_id = $( this ).attr('id');
									jw_id = jw_id.replace('_media','');
									jwplayer( jw_id ).stop();									
								});
							}												
						} 
			
						function onAfter(currElement, nextElement, opts, isForward) {

							// 
							var timeouts = timeout_array.slice(0, -1).split(','),					
								index = opts.currSlide,
								timeout = parseInt(timeouts[index]) +'s',
								caption_timeout = parseInt(timeouts[index] * 1000 - 2000),
								effect = $( gallery ).attr("data-stage-effect");
						
						
							if( !$(this).find('.caption-wrap').hasClass('caption-hover') )
							{						
								// None CSS3 animation
								if( $.support.transition === false )
								{
									$(this).find('.caption-wrap').addClass('active',700, 'easeOutSine').delay( caption_timeout ).queue(function(next){
										$(this).find('.caption-wrap').removeClass('active', 700, "easeOutBounce" );
										next();
									});							
								}
								else
								{		
									$(this).find('.caption-wrap').addClass('active' ).delay( caption_timeout ).queue(function(next){
										$(this).find('.caption-wrap').removeClass('active' );
										next();
									});		
								}
							}
							
							// Zoom effect
							if( effect == 'fadeZoom' )
							{				
								$(this).find('img,.image-wrapper').css({ 
									'-webkit-animation': 'imagezoom ease-in '+ timeout,
									'-webkit-animation-delay' : '0.6s',
									'-webkit-animation-fill-mode' : 'forwards',
									'animation': 'imagezoom ease-in '+ timeout,
									'animation-delay' : '0.6s',
									'animation-fill-mode' : 'forwards'
								});
								
								if( $.support.transition === false )
								{														
									//$(this).find('img').animate({ 'max-width' : '110%','width' : '110%','max-height' : '110%' }, parseInt(timeouts[index] * 2000 ) );
								}
							}							
																				
							$( gallery +' iframe').attr('src', '');
													
							var videoid = $(this).find('.jwplayer').attr("id"),
								data_src = $(this).find('iframe').attr('data-src');
								
							// Apply data-src to iframe src attribute
							if( data_src )
							{
								console.log('data_src:before', data_src);
								$(this).find('iframe').attr('src', data_src);
							}
							
							// JW player
							if( $( this ).find('.jwplayer-wrapper.autoplay').length )
							{	
								var jw_id = $( this ).find('.jwvideo').attr('id');
								
								jw_id = jw_id.replace('_media','');
								jwplayer( jw_id ).play();
							}
	
			 	 			var	slides_total = $( gallery + ' .dynamic-frame').attr('data-total'),
				 				items = $( gallery ).find('.stage-slider .panel');				
								
							if( $( gallery ).attr('data-load-method') == 'auto_load' && items.length < slides_total && $( gallery ).attr('data-query') != 'loading' )
							{
								tvaStageAjaxLoadData( gallery, opts, items.length );
							}
						} 
			
						function calculateTimeout(currElement, nextElement, opts, isForward) { 
						
							var timeouts = timeout_array.slice(0, -1).split(','),					
								index = opts.currSlide;
		
							return timeouts[index] * 1000;
						} 		



					$(window).load(function()
					{																				
						var panel_first = $( gallery ).find('.panel:first'),
							init_height = panel_first.height();
				
						$( gallery ).resizegallery( init_height ,'animate','.panel','.slider-inner-wrap','', init_height ); // resize gallery
						
						$( gallery ).animate({ opacity:1 });
						
						$(window).trigger('resize');	
					});
		
			});
	}
		
	stage_gallery();
	
})(jQuery);